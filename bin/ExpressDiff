#!/usr/bin/env bash
# ExpressDiff CLI wrapper for module-based deployments
set -euo pipefail

# Resolve install directory (read-only code location)
if [[ -n "${EBROOTEXPRESSDIFF:-}" ]]; then
  INSTALL_DIR="${EBROOTEXPRESSDIFF}"
elif [[ -n "${EXPRESSDIFF_HOME:-}" ]]; then
  INSTALL_DIR="${EXPRESSDIFF_HOME}"
else
  # Fallback: infer from this script location (../)
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  INSTALL_DIR="$(cd "${SCRIPT_DIR}/.." && pwd)"
fi

subcmd="${1:-run}"
shift || true

case "${subcmd}" in
  launch)
    # Original interactive launcher (backend only, frontend only, or both)
    # Determine or set work directory before launching
    if [[ -z "${EXPRESSDIFF_WORKDIR:-}" ]]; then
      if [[ -n "${SCRATCH:-}" ]]; then
        WORKDIR="${SCRATCH}/ExpressDiff"
      else
        echo "ERROR: No work directory configured." >&2
        echo "Set EXPRESSDIFF_WORKDIR or SCRATCH to a writable location (e.g., /scratch/$USER)." >&2
        exit 1
      fi
      export EXPRESSDIFF_WORKDIR="${WORKDIR}"
    else
      WORKDIR="${EXPRESSDIFF_WORKDIR}"
    fi
    mkdir -p "${WORKDIR}" "${WORKDIR}/runs"
    echo "ExpressDiff â€” install: ${INSTALL_DIR}"
    echo "Work directory: ${WORKDIR}"
    exec "${INSTALL_DIR}/launch_expressdiff.sh" "$@"
    ;;
  run)
    # New development-friendly run flow: prompt, create ./ExpressDiff workdir, then start backend
    echo "[ExpressDiff] Recommendation: run from /scratch/$USER to avoid filling limited home space." >&2
    echo "[ExpressDiff] Current directory: $PWD" >&2
    echo >&2
    read -r -p "Create ./ExpressDiff working directory here and continue? (y/N): " REPLY
    if [[ ! "$REPLY" =~ ^[Yy]$ ]]; then
      echo "Cancelled. Please re-run from /scratch/$USER for best results." >&2
      exit 1
    fi

    WORKDIR="$PWD/ExpressDiff"
    mkdir -p "$WORKDIR" "$WORKDIR/runs" "$WORKDIR/mapping_in"
    export EXPRESSDIFF_WORKDIR="$WORKDIR"
    echo "[ExpressDiff] Working directory set to: $EXPRESSDIFF_WORKDIR" >&2

    LAUNCHER_BIN="${INSTALL_DIR}/bin/expressdiff_module_api.sh"
    if [[ ! -x "$LAUNCHER_BIN" ]]; then
      echo "ERROR: Backend launcher not found: $LAUNCHER_BIN" >&2
      exit 1
    fi
    "$LAUNCHER_BIN" --host 0.0.0.0 --port 8000 --background
    echo "[ExpressDiff] Backend starting on http://0.0.0.0:8000" >&2
    echo "[ExpressDiff] Logs: $EXPRESSDIFF_WORKDIR/backend.log" >&2
    echo "[ExpressDiff] API docs: http://0.0.0.0:8000/docs" >&2
    ;;
  api)
    # Start API-only launcher (port optional, default 8000)
    # Determine or set work directory before starting API
    if [[ -z "${EXPRESSDIFF_WORKDIR:-}" ]]; then
      if [[ -n "${SCRATCH:-}" ]]; then
        WORKDIR="${SCRATCH}/ExpressDiff"
      else
        echo "ERROR: No work directory configured." >&2
        echo "Set EXPRESSDIFF_WORKDIR or SCRATCH to a writable location (e.g., /scratch/$USER)." >&2
        exit 1
      fi
      export EXPRESSDIFF_WORKDIR="${WORKDIR}"
    else
      WORKDIR="${EXPRESSDIFF_WORKDIR}"
    fi
    mkdir -p "${WORKDIR}" "${WORKDIR}/runs"
    cd "${INSTALL_DIR}"
    exec python -m uvicorn backend.api.main:app --host 0.0.0.0 --port "${1:-8000}"
    ;;
  help|-h|--help)
    cat <<EOF
================================================================================
ExpressDiff - RNA-seq Differential Expression Analysis Pipeline
================================================================================

ExpressDiff is an automated RNA-seq analysis pipeline that runs on HPC 
infrastructure. The pipeline performs quality control, read trimming, genome 
alignment, feature quantification, and differential expression analysis.

FEATURES:
  - FastAPI backend with React frontend
  - SLURM job orchestration
  - Quality control with FastQC and MultiQC
  - Read trimming with Trimmomatic
  - Alignment with STAR
  - Quantification with featureCounts
  - Differential expression with DESeq2

Usage: ExpressDiff [command]

Commands:
  run            Prompt to create ./ExpressDiff here; start backend using this directory
  launch         Original interactive launcher (backend/frontend chooser)
  api [PORT]     Start only the FastAPI backend on PORT (default: 8000)
  help           Show this help message

Environment:
  EBROOTEXPRESSDIFF    Install directory provided by EasyBuild module
  EXPRESSDIFF_HOME     Install directory (fallback if EBROOT not set)
  EXPRESSDIFF_WORKDIR  Work dir override (for development). Otherwise derived from \$SCRATCH.

Support:
  For questions, issues, or assistance, contact: vth3bk@virginia.edu

================================================================================
EOF
    ;;
  *)
    echo "Unknown command: ${subcmd}" >&2
    echo "Try: ExpressDiff help" >&2
    exit 1
    ;;
 esac
